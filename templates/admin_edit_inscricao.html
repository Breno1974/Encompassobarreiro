<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Editar Inscrição - Encompasso Barreiro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Fonte opcional -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      min-height: 100vh;
    }

    .navbar {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 1rem 0;
    }

    .navbar-brand {
      font-weight: 600;
      font-size: 1.3rem;
      color: white !important;
    }

    .navbar-nav .nav-link {
      color: rgba(255, 255, 255, 0.9) !important;
      font-weight: 500;
      transition: all 0.3s ease;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      margin: 0 0.2rem;
    }

    .navbar-nav .nav-link:hover {
      color: white !important;
      background-color: rgba(255, 255, 255, 0.1);
    }

    .main-container {
      padding: 2rem 0;
    }

    .edit-card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      border: 1px solid #e9ecef;
    }

    .edit-header {
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 1.5rem;
      margin-bottom: 2rem;
    }

    .edit-header h1 {
      color: #1a1a1a;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .edit-header p {
      color: #6c757d;
      margin-bottom: 0;
    }

    .form-label {
      font-weight: 500;
      color: #495057;
      margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
    }

    .btn-save {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border: none;
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-save:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
      color: white;
    }

    .btn-cancel {
      background: #6c757d;
      border: none;
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .btn-cancel:hover {
      background: #5a6268;
      color: white;
      text-decoration: none;
    }

    .alert {
      border-radius: 8px;
      border: none;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
    }

    .form-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid #e9ecef;
    }

    .form-section h5 {
      color: #495057;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .value-display {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-weight: 600;
      color: #1976d2;
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 1rem 0;
      }

      .edit-card {
        padding: 1.5rem;
        margin: 0 1rem;
      }

      .edit-header {
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-user-edit me-2"></i>
        Editar Inscrição
      </a>
      
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
          <i class="fas fa-arrow-left me-1"></i>Voltar ao Dashboard
        </a>
        <a class="nav-link" href="{{ url_for('admin_logout') }}">
          <i class="fas fa-sign-out-alt me-1"></i>Sair
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container main-container">
    <div class="edit-card">
      <div class="edit-header">
        <h1><i class="fas fa-user-plus me-2"></i>Editar Inscrição #{{ inscricao.id }}</h1>
        <p>Modifique os dados da inscrição conforme necessário</p>
      </div>

      <!-- Mensagens de Flash -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
              <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="POST">
        <!-- Informações Básicas -->
        <div class="form-section">
          <h5><i class="fas fa-user"></i>Informações Básicas</h5>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="servidor" class="form-label">Servidor</label>
              <select class="form-select" id="servidor" name="servidor" required>
                {% for servidor_option in servidores %}
                  <option value="{{ servidor_option }}" {{ 'selected' if inscricao.servidor == servidor_option else '' }}>
                    {{ servidor_option }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="nome" class="form-label">Nome do Cliente</label>
              <input type="text" class="form-control" id="nome" name="nome" value="{{ inscricao.nome or '' }}" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="telefone" class="form-label">Telefone</label>
              <input type="text" class="form-control" id="telefone" name="telefone" value="{{ inscricao.telefone or '' }}" required>
            </div>
          </div>
        </div>

        <!-- Informações do Quarto -->
        <div class="form-section">
          <h5><i class="fas fa-bed"></i>Informações do Quarto</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="tipo_quarto" class="form-label">Tipo de Quarto</label>
              <select class="form-select" id="tipo_quarto" name="tipo_quarto" required onchange="atualizarValorQuarto()">
                <option value="duplo" {{ 'selected' if inscricao.tipo_quarto == 'duplo' else '' }}>Duplo - R$ 380,00</option>
                <option value="triplo" {{ 'selected' if inscricao.tipo_quarto == 'triplo' else '' }}>Triplo - R$ 350,00</option>
                <option value="coletivo" {{ 'selected' if inscricao.tipo_quarto == 'coletivo' else '' }}>Coletivo - R$ 299,90</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="valor_quarto" class="form-label">Valor do Quarto (R$)</label>
              <input type="number" class="form-control" id="valor_quarto" name="valor_quarto" step="0.01" min="0" 
                     value="{{ inscricao.valor_quarto or 0 }}" required readonly>
            </div>
          </div>
        </div>

        <!-- Informações de Pagamento -->
        <div class="form-section">
          <h5><i class="fas fa-credit-card"></i>Informações de Pagamento</h5>
          <div class="row">
            <div class="col-md-3 mb-3">
              <label for="tipo_pagamento" class="form-label">Tipo de Pagamento</label>
              <select class="form-select" id="tipo_pagamento" name="tipo_pagamento" required onchange="atualizarCamposPagamento()">
                <option value="pix" {{ 'selected' if inscricao.tipo_pagamento == 'pix' else '' }}>PIX</option>
                <option value="dinheiro" {{ 'selected' if inscricao.tipo_pagamento == 'dinheiro' else '' }}>Dinheiro</option>
                <option value="fiado" {{ 'selected' if inscricao.tipo_pagamento == 'fiado' else '' }}>Fiado</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label for="valor_entrada" class="form-label">Valor de Entrada (R$)</label>
              <input type="number" class="form-control" id="valor_entrada" name="valor_entrada" step="0.01" min="0" 
                     value="{{ inscricao.valor_entrada or 0 }}" onchange="calcularValorRestante()">
            </div>
            <div class="col-md-3 mb-3">
              <label for="valor_restante" class="form-label">Valor Restante (R$)</label>
              <input type="number" class="form-control value-display" id="valor_restante" name="valor_restante" step="0.01" min="0" 
                     value="{{ inscricao.valor_restante or 0 }}" readonly>
            </div>
            <div class="col-md-3 mb-3" id="campo_vencimento">
              <label for="data_vencimento" class="form-label">Data de Vencimento</label>
              <input type="date" class="form-control" id="data_vencimento" name="data_vencimento" 
                     value="{{ inscricao.data_vencimento.strftime('%Y-%m-%d') if inscricao.data_vencimento else '' }}">
              <div class="form-text">Apenas para pagamentos fiados</div>
            </div>
          </div>
        </div>

        <!-- Botões de Ação -->
        <div class="d-flex gap-3 justify-content-end">
          <a href="{{ url_for('admin_dashboard') }}" class="btn btn-cancel">
            <i class="fas fa-times me-2"></i>Cancelar
          </a>
          <button type="submit" class="btn btn-save">
            <i class="fas fa-save me-2"></i>Salvar Alterações
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Valores dos quartos
    const valoresQuartos = {
      'duplo': 380.00,
      'triplo': 350.00,
      'coletivo': 299.90
    };

    // Atualizar valor do quarto baseado no tipo selecionado
    function atualizarValorQuarto() {
      const tipoQuarto = document.getElementById('tipo_quarto').value;
      const valorQuarto = document.getElementById('valor_quarto');
      
      valorQuarto.value = valoresQuartos[tipoQuarto] || 0;
      calcularValorRestante();
    }

    // Calcular valor restante
    function calcularValorRestante() {
      const valorQuarto = parseFloat(document.getElementById('valor_quarto').value) || 0;
      const valorEntrada = parseFloat(document.getElementById('valor_entrada').value) || 0;
      const valorRestante = valorQuarto - valorEntrada;
      
      document.getElementById('valor_restante').value = Math.max(0, valorRestante).toFixed(2);
    }

    // Mostrar/ocultar campos baseado no tipo de pagamento
    function atualizarCamposPagamento() {
      const tipoPagamento = document.getElementById('tipo_pagamento').value;
      const campoVencimento = document.getElementById('campo_vencimento');
      const dataVencimento = document.getElementById('data_vencimento');
      const valorEntrada = document.getElementById('valor_entrada');
      
      if (tipoPagamento === 'fiado') {
        campoVencimento.style.display = 'block';
        dataVencimento.required = true;
        valorEntrada.disabled = false;
      } else {
        campoVencimento.style.display = 'none';
        dataVencimento.required = false;
        dataVencimento.value = '';
        
        if (tipoPagamento === 'pix' || tipoPagamento === 'dinheiro') {
          // Para pagamento à vista, entrada = valor total
          const valorQuarto = parseFloat(document.getElementById('valor_quarto').value) || 0;
          valorEntrada.value = valorQuarto.toFixed(2);
          valorEntrada.disabled = true;
          calcularValorRestante();
        }
      }
    }

    // Executar lógicas iniciais
    document.addEventListener('DOMContentLoaded', function() {
      atualizarValorQuarto();
      atualizarCamposPagamento();

      // Adicionar listener para o formulário
      const form = document.getElementById('editInscricaoForm');
      form.addEventListener('submit', async function(event) {
        event.preventDefault(); // Previne o envio padrão do formulário

        const inscricaoId = {{ inscricao.id }};
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Se data_vencimento estiver vazio, enviar null
        if (data.data_vencimento === '') {
          data.data_vencimento = null;
        }

        // Converter valores numéricos
        if (data.valor_quarto) {
          data.valor_quarto = parseFloat(data.valor_quarto);
        }
        if (data.valor_entrada) {
          data.valor_entrada = parseFloat(data.valor_entrada);
        }
        if (data.valor_restante) {
          data.valor_restante = parseFloat(data.valor_restante);
        }

        try {
          const response = await fetch(`/admin/api/inscricoes/${inscricaoId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (response.ok) {
            alert(result.message || 'Inscrição atualizada com sucesso!');
            window.location.href = '{{ url_for('admin_dashboard') }}'; // Redireciona para o dashboard
          } else {
            alert(result.error || 'Erro ao atualizar inscrição.');
          }
        } catch (error) {
          console.error('Erro:', error);
          alert('Ocorreu um erro ao tentar atualizar a inscrição.');
        }
      });
    });

    // Formatação de telefone
    document.getElementById('telefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length <= 11) {
        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        if (value.length < 14) {
          value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
        }
      }
      e.target.value = value;
    });

    // Validação de valores
    document.getElementById('valor_entrada').addEventListener('input', function(e) {
      let value = parseFloat(e.target.value);
      const valorQuarto = parseFloat(document.getElementById('valor_quarto').value) || 0;
      
      if (isNaN(value) || value < 0) {
        e.target.value = 0;
      } else if (value > valorQuarto) {
        e.target.value = valorQuarto.toFixed(2);
      }
      
      calcularValorRestante();
    });
  </script>
</body>
</html>

